/**
	Open Innovations Warm Places Finder
	Version 0.2
 */
!function(t){var e=t.OI||{};function o(t){t||(t={}),this.name="Open Innovations Warm Spaces Finder",this.version="0.2";var o=new a({title:this.name,version:this.version}).message;if(!t.el)return o("error","No output area to attach to."),this;this.btn=document.getElementById("find"),this.btn||(this.btn=document.createElement("button"),this.btn.innerHTML="Find spaces near me",this.btn.classList.add("c13-bg"),t.el.appendChild(this.btn));var l=this;this.btn.addEventListener("click",function(t){t.preventDefault(),t.stopPropagation(),l.getLocation()}),this.key=document.getElementById("key-holder"),this.toggles={};var h=document.querySelectorAll("#key .keyitem input");for(i=0;i<h.length;i++)this.toggles[h[i].getAttribute("data")]=new s(h[i],{this:this,callback:function(t){this.updateList()}});if(this.loader=document.createElement("div"),this.loader.classList.add("loader"),t.el.appendChild(this.loader),this.list=document.createElement("ul"),this.list.classList.add("list","grid"),this.tiler=e.TiledDataLayer(function t(e,i){for(var o in i)try{i[o].constructor==Object?e[o]=t(e[o],i[o]):e[o]=i[o]}catch(t){e[o]=i[o]}return e}({url:"https://odileeds.github.io/osm-geojson/tiles/bins/{z}/{x}/{y}.geojson",zoomLevels:[12],finder:this,loaded:function(t,e){var i,s,n,a,l,h,u,c;for(o("info","There are "+t.length+" tiles."),s={type:"FeatureCollection",features:[]},i=0;i<t.length;i++)if(t[i].data&&t[i].data.features)for(l=0;l<t[i].data.features.length;l++)"Feature"===t[i].data.features[l].type&&s.features.push(t[i].data.features[l]);if(h=s.features,e.finder.region){for(u=[],o("info","Checking if in region",e.finder.region),i=0;i<h.length;i++)e.finder.region.contains(h[i].geometry.coordinates[0],h[i].geometry.coordinates[1])&&u.push(h[i]);u=u.sort(function(t,e){return t.properties.title>e.properties.title})}else{for(n=e.finder.lat,a=e.finder.lon,i=0;i<h.length;i++)c=h[i].geometry.coordinates,h[i].distance=r([a,n],c);u=h.sort(function(t,e){return t.distance-e.distance})}e.finder.sorted=u,e.finder.updateList()}},t.tiles||{})),"object"==typeof t.sources)this.sources=t.sources;else{"string"==typeof t.sources&&(t.sources=t.sources.replace(/\{% include_relative ([^\%]+) %\}/,function(t,e){return e}));var u=t.sources||"data/sources.json";fetch(u,{}).then(t=>t.json()).then(t=>{this.sources=t,this.init()}).catch(t=>{o("error","Unable to load sources from "+u)})}function c(t){var e="";return""==t?"":(t.url&&(e+='<a href="'+t.url+'" target="_source">'),t.title&&(e+=t.title),t.url&&(e+="</a>"),t.map&&t.map.url&&t.map.url!=t.url&&(e+=' / <a href="'+t.map.url+'" target="_source">Map</a>'),t.register&&t.register.url&&t.register.url!=t.url&&(e+=' / <a href="'+t.register.url+'" target="_source">Contribute</a>'),e?'<div class="source b2-bg"><strong>From:</strong> '+e+"</div>":"")}function d(t){var e,i,o,s,n,r,a,l,h,u,c,d,p,g,f,m,y,v,b,M,L,w,x;if(u="closed",b="",t){var k={Su:"Sun",Mo:"Mon",Tu:"Tue",We:"Wed",Th:"Thu",Fr:"Fri",Sa:"Sat"};for(a={Su:0,Mo:1,Tu:2,We:3,Th:4,Fr:5,Sa:6},n=new Date,r=n.getNthOfMonth(),l=t.split(/\; /),c=!1,e=0;e<l.length;e++){for(o in L=(h=l[e].split(/ /))[0].split(/-/),s=n.getDay(),v=n.getHours()+n.getMinutes()/60,d="",a)s==a[o]&&(d=o);for(i in c=!1,1==L.length?c=L[0].match(d):(w=a[L[0]],x=a[L[1]],s>=w&&s<=x&&(c=!0)),M="",h[0]=h[0].replace(/\[([^\]]+)\]/,function(t,e){return e.match(r)||(c=!1),M="<sup>"+e+"</sup>",""}),k)h[0]=h[0].replace(new RegExp(i,"g"),k[i]);if(b+='<li data="'+t+'">'+h[0]+M+": "+h[1]+"</li>",c)for(p=h[1].split(/,/),g=0;g<p.length;g++)m=(f=p[g].split(/-/))[0].split(/:/),y=f[1].split(/:/),m=parseInt(m[0])+parseInt(m[1])/60,y=parseInt(y[0])+parseInt(y[1])/60,m<=v&&y>v&&(u="open"),v<m&&v>m-.5&&(u="opening-soon"),v<y&&v>y-.25&&(u="closing-soon")}}return{type:u,times:b?'<ul class="times">'+b+"</ul>":""}}return this.loadArea=function(t){fetch(t,{}).then(t=>t.json()).then(t=>{var e;"Polygon"===t.geometry.type?e=t.geometry.coordinates[0]:"MultiPolygon"===t.geometry.type&&(e=t.geometry.coordinates[0][0]),this.setArea(e)}).catch(e=>{o("error","Unable to load URL "+t,{type:"ERROR",extra:{}})})},this.updateList=function(){var e,i,s,n,r,a,l,h,u,p,g,f,m,y,v,b=this.region?this.sorted.length:Math.min(60,this.sorted.length);for(e=this.location?this.location.coords.accuracy:50,n=(i=Math.log10(e))-(s=Math.floor(i)),r=[1,2,5,10],a=new Array(r.length),l=-1,h=1e100,u=0;u<r.length;u++)a[u]=Math.abs(n-Math.log10(r[u])),a[u]<h&&(h=a[u],l=u);for(m=Math.pow(10,s)*r[l],o("info","Location accuracy set to "+m+"m"),m>200&&(m=200),f="",u=0,added=0;u<this.sorted.length&&added<b;u++){p=this.sorted[u].properties,g=this.sorted[u].distance?Math.ceil(this.sorted[u].distance/m)*m:-1;var M={};p.hours&&p.hours.opening&&(M=d(p.hours.opening));var L=M.type;if(L||(L="unknown"),this.toggles[L]){var w=this.toggles[L].class;this.toggles[L].checked&&(f+='<li tabindex="0" class="'+w+'"><div>',f+=p.url?'<a href="'+p.url+'/" target="_source">':"<div>",f+='<div class="doublepadded">',f+="<h3>"+p.title+"</h3>",p.address&&(f+='<p class="address">'+p.address+"</p>"),f+=g>=0?'<p><span class="dist">'+g+"m</span> or so away</p>":"",p.description&&(f+="<p><strong>Notes:</strong> "+p.description+"</p>"),p.hours&&p.hours._text&&(f+='<p class="times"><strong>Opening hours (parsed):</strong></p>'+M.times+(p.hours._text?'<p class="times"><strong>Opening hours (original text):</strong></p><p>'+p.hours._text+"</p>":"")),f+='<p><strong>Map:</strong> <a href="https://www.openstreetmap.org/#map=18/'+(y=this.sorted[u].geometry.coordinates[1])+"/"+(v=this.sorted[u].geometry.coordinates[0])+'" target="_osm">OpenStreetMap</a> | <a href="https://www.google.com/maps/@'+y+","+v+',18z" target="_gmap">Google</a> | <a href="https://www.bing.com/maps/?cp='+y+"%7E"+v+'&lvl=18" target="_bing">Bing</a></p>',f+="</div>",f+=p.url?"</a>":"</div>",f+=c(this.sources[p._source]),f+="</div></li>",added++)}else o("warn","No toggle of type "+L,p)}return this.list.innerHTML=f,t.el.appendChild(this.list),this.loader.innerHTML="",this.key.style.display="block",this},this.loadGSS=function(t){var e,i,o={PCON:{title:"Parliamentary Constituencies (2017)",patterns:[/^E14[0-9]{6}$/,/^W07[0-9]{6}$/,/^S14[0-9]{6}$/,/^N06[0-9]{6}$/],geojson:"https://open-innovations.github.io/geography-bits/data/PCON17CD/{{gss}}.geojsonl"},WD:{title:"Wards (2021)",patterns:[/^E05[0-9]{6}$/,/^W05[0-9]{6}$/,/^S13[0-9]{6}$/,/^N08[0-9]{6}$/],geojson:"https://open-innovations.github.io/geography-bits/data/WD21CD/{{gss}}.geojsonl"},LAD:{title:"Local Authority Districts (2021)",patterns:[/^E06[0-9]{6}$/,/^W06[0-9]{6}$/,/^S12[0-9]{6}$/,/^E07[0-9]{6}$/,/^E08[0-9]{6}$/,/^E09[0-9]{6}$/],geojson:"https://open-innovations.github.io/geography-bits/data/LAD21CD/{{gss}}.geojsonl"}},s="";for(e in o)for(o[e].matches={},i=0;i<o[e].patterns.length;i++)t.match(o[e].patterns[i])&&(s=o[e].geojson.replace(/\{\{gss\}\}/,t));return s&&this.loadArea(s),this},this.init=function(){if(location.search){var t=location.search.match(/gss=([^\&]*[EWNS][0-9]{8})/);2==t.length&&this.loadGSS(t[1])}return this},this.getLocation=function(){this.startLocation("getCurrentPosition")},this.startLocation=function(t){this.loader.innerHTML='<svg version="1.1" width="64" height="64" viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg"><g transform="matrix(.11601 0 0 .11601 -49.537 -39.959)"><path d="m610.92 896.12m183.9-106.17-183.9-106.17-183.9 106.17v212.35l183.9 106.17 183.9-106.17z" fill="black"><animate attributeName="opacity" values="1;0;0" keyTimes="0;0.7;1" dur="1s" begin="-0.83333s" repeatCount="indefinite" /></path><path d="m794.82 577.6m183.9-106.17-183.9-106.17-183.9 106.17v212.35l183.9 106.17 183.9-106.17z" fill="black"><animate attributeName="opacity" values="1;0;0" keyTimes="0;0.7;1" dur="1s" begin="-0.6666s" repeatCount="indefinite" /></path><path d="m1162.6 577.6m183.9-106.17-183.9-106.17-183.9 106.17v212.35l183.9 106.17 183.9-106.17z" fill="black"><animate attributeName="opacity" values="1;0;0" keyTimes="0;0.7;1" dur="1s" begin="-0.5s" repeatCount="indefinite" /></path><path d="m1346.5 896.12m183.9-106.17-183.9-106.17-183.9 106.17v212.35l183.9 106.17 183.9-106.17z" fill="black"><animate attributeName="opacity" values="1;0;0" keyTimes="0;0.7;1" dur="1s" begin="-0.3333s" repeatCount="indefinite" /></path><path d="m1162.6 1214.6m183.9-106.17-183.9-106.17-183.9 106.17v212.35l183.9 106.17 183.9-106.17z" fill="black"><animate attributeName="opacity" values="1;0;0" keyTimes="0;0.7;1" dur="1s" begin="-0.1666s" repeatCount="indefinite" /></path><path d="m794.82 1214.6m183.9-106.17-183.9-106.17-183.9 106.17v212.35l183.9 106.17 183.9-106.17z" fill="black"><animate attributeName="opacity" values="1;0;0" keyTimes="0;0.7;1" dur="1s" begin="0s" repeatCount="indefinite" /></path></g></svg>',t||(t="watchPosition");var e=this;o("info","Getting location..."),this.watchID=navigator.geolocation[t](function(t){e.updateLocation(t)},function(){o("error","Having trouble finding your location.")},{enableHighAccuracy:!0,maximumAge:3e4,timeout:27e3})},this.stopLocation=function(){return navigator.geolocation.clearWatch(this.watchID),this},this.updateLocation=function(t){this.location=t,delete this.region,this.setLocation(t.coords.latitude,t.coords.longitude)},this.setArea=function(t){return this.region=new n(t),this.setBounds(this.region.boundingBox()),this},this.setBounds=function(e){return o("info","Set bounds",e),delete this.lat,delete this.lon,e&&this.tiler.getTiles(e,t.tiles.zoomLevels[0]),this},this.setLocation=function(e,i){var s;return o("info","Set location",e,i),this.lat=e,this.lon=i,.03,.06,s={_southWest:{lat:this.lat-.03,lng:this.lon-.06},_northEast:{lat:this.lat+.03,lng:this.lon+.06}},this.tiler.getTiles(s,t.tiles.zoomLevels[0]),this},Date.prototype.getNthOfMonth=function(){var t,e=new Date(this),i=this.getDate(),o=this.getDay(),s=0;for(t=1;t<=i;t++)e.setDate(t),e.getDay()==o&&s++;return s},this}function s(t,e){e||(e={});var i=t.closest("li").getAttribute("class").replace(/ keyitem.*$/,"");this.checked=t.checked,this.type=t.getAttribute("data"),this.class=i;var o=this;return t.addEventListener("change",function(i){o.checked=t.checked,"function"==typeof e.callback&&e.callback.call(e.this||this)}),this}function n(t){this.points=t||[],this.length=t.length}function r(t,e){var i=Math.PI/180,o=t[1]*i,s=e[1]*i,n=(t[1]-e[1])*i,r=(t[0]-e[0])*i,a=Math.sin(n/2)*Math.sin(n/2)+Math.cos(o)*Math.cos(s)*Math.sin(r/2)*Math.sin(r/2);return 6378100*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)))}function a(t){return t||(t={}),t.title||(t.title="Log"),t.version||(t.version="2.0"),this.message=function(...e){var i=e.shift();"string"!=typeof i&&(i="log");var o=["%c"+t.title+" "+t.version+"%c"];e.length>0&&(o[0]+=":","string"==typeof e[0]&&(o[0]+=" "+e.shift())),o.push("font-weight:bold;"),o.push(""),e.length>0&&(o=o.concat(e)),console[i].apply(null,o)},this}e.ready||(e.ready=function(t){"loading"!=document.readyState?t():document.addEventListener("DOMContentLoaded",t)}),n.prototype.area=function(){var t,e,i,o,s=0;for(t=0,e=this.length-1;t<this.length;e=t,t++)i=this.points[t],o=this.points[e],s+=i[0]*o[1],s-=i[1]*o[0];return s/=2},n.prototype.contains=function(t,e){var i,o,s=!1,n=this.length;for(i=0,o=n-1;i<n;o=i++)vertx=this.points[i][0],verty=this.points[i][1],this.points[i][1]>e!=this.points[o][1]>e&&t<(this.points[o][0]-this.points[i][0])*(e-this.points[i][1])/(this.points[o][1]-this.points[i][1])+this.points[i][0]&&(s=!s);return s},n.prototype.centroid=function(){var t,e,i,o,s,n=0,r=0;for(t=0,e=this.length-1;t<this.length;e=t,t++)o=this.points[t],s=this.points[e],i=o[0]*s[1]-s[0]*o[1],n+=(o[0]+s[0])*i,r+=(o[1]+s[1])*i;return[n/(i=6*this.area()),r/i]},n.prototype.boundingBox=function(){var t,e=-90,i=-180,o=90,s=180;for(t=0,this.length-1;t<this.length;t,t++)e=Math.max(e,this.points[t][1]),o=Math.min(o,this.points[t][1]),i=Math.max(i,this.points[t][0]),s=Math.min(s,this.points[t][0]);return{_southWest:{lat:o,lng:s},_northEast:{lat:e,lng:i},N:e,S:o,E:i,W:s}},e.TiledDataLayer=function(t){return new function(t){t||(t={}),this.title="TiledDataLayer",this.version="0.1";var i=new a({title:this.title,version:this.version}).message;if(!t.url)return i("error","No url provided for data layer"),this;var o=[],s={};"undefined"==typeof L&&i("warn","No map to attach to");var n=6378137,r=.5/(Math.PI*n);function l(t,e){return t/Math.pow(2,e)*360-180}function h(t,e){var i=Math.PI-2*Math.PI*t/Math.pow(2,e);return 180/Math.PI*Math.atan(.5*(Math.exp(i)-Math.exp(-i)))}if(this.xyz=function(e,i){var o,s,n,r,a,u,c,d,g;for("number"==typeof e.N&&(e={_northEast:{lat:e.N,lng:e.E},_southWest:{lat:e.S,lng:e.W}}),o=e._northEast.lat,s=e._southWest.lat,n=e._northEast.lng,r=e._southWest.lng,t.limits&&(o=Math.min(o,t.limits.N),s=Math.max(s,t.limits.S),n=Math.min(n,t.limits.E),r=Math.min(n,t.limits.W)),d=p(o,r,i),g=p(s,n,i),c=[],a=d.x;a<=g.x;a++)for(u=d.y;u<=g.y;u++)c.push({x:a,y:u,z:i,b:{_northEast:{lat:h(u,i),lng:l(a+1,i)},_southWest:{lat:h(u+1,i),lng:l(a,i)}}});return c},t.map)var u,c=new L.LayerGroup;function d(t,e,o){fetch(t,{}).then(t=>t.json()).then(t=>{s[e.z][e.y][e.x].loaded=!0,s[e.z][e.y][e.x].data=t,"function"==typeof o&&o.call(this)}).catch(n=>{s[e.z][e.y][e.x].loaded=!0,s[e.z][e.y][e.x].data={type:"FeatureCollection",features:[]},"function"==typeof o&&o.call(this),i("error","Unable to load URL "+t)})}function p(t,e,i){var o=Math.PI/180,s=Math.max(Math.min(Math.sin(t*o),1-1e-15),-(1-1e-15)),a=256*Math.pow(2,i),l={x:n*e*o,y:n*Math.log((1+s)/(1-s))/2};return l.x=g(a*(r*l.x+.5)),l.y=g(a*(-r*l.y+.5)),l}function g(t){return Math.floor(t/256)}return this.addToMap=function(i,o){var s;if(t.map){c.addTo(t.map);var n=o.colour||"#e6007c";function r(t,e){return L.divIcon({className:"oi-map-marker",html:'<svg overflow="visible" width="24" height="40" class="oi-map-marker" style="transform:translate3d(0,0,0)"><path d="M 0,0 L -10.84,-22.86 A 12 12 1 1 1 10.84,-22.86 L 0,0 z" fill="{fill}" fill-opacity="1"></path><ellipse cx="0" cy="-27.5" rx="4" ry="4" fill="white"></ellipse></svg>'.replace(/\{fill\}/,n),iconSize:[0,0],iconAnchor:[0,0]})}var a=r();if(u&&c.removeLayer(u),"function"==typeof L.markerClusterGroup){u=L.markerClusterGroup({chunkedLoading:!0,maxClusterRadius:60,iconCreateFunction:function(t){return L.divIcon({html:'<div class="marker-group" style="background:'+n+';color:white;border-radius:100%;text-align:center;font-size:0.8em;line-height:2.5em;width:2.5em;opacity:0.85;">'+t.getChildCount()+"</div>",className:""})},disableClusteringAtZoom:17,spiderfyOnMaxZoom:!0,showCoverageOnHover:!1,zoomToBoundsOnClick:!0});var l,h,d=[];for(s=0;s<i.features.length;s++)"Point"==i.features[s].geometry.type&&(l=i.features[s].geometry.coordinates,h=L.marker([l[1],l[0]],{icon:a}),d.push(h));u.addLayers(d)}else if("function"==typeof PruneClusterForLeaflet){for((u=new PruneClusterForLeaflet).BuildLeafletClusterIcon=function(t){var i,o,s,n,r,a,l,h,u=t.population;for(i=0,o=0;o<this.Cluster._clusters.length;o++)i=Math.max(i,this.Cluster._clusters[o].population);return r=(s=e.ColourScale.getColour(1)).colour.replace(",1)",",0.5)"),a=s.colour.replace(",1)",",0.2)"),n=.7+.3*Math.sqrt(u/i),1==(l=(""+u).length)?h=1.8:2==l?h=2.2:3==l?h=2.6:4==l?h=3:5==l&&(h=3),L.divIcon({html:'<div class="marker-group" style="background:'+s.colour+";color:"+s.contrast+";box-shadow:0 0 0 0.2em "+r+",0 0 0 0.4em "+a+";font-family:Poppins;border-radius:100%;text-align:center;font-size:"+n+"em;line-height:"+h+"em;width:"+h+'em;opacity:0.85;">'+u+"</div>",className:""})},s=0;s<i.features.length;s++)if("Point"==i.features[s].geometry.type){l=i.features[s].geometry.coordinates;var p=new PruneCluster.Marker(l[1],l[0]);p.data.icon=r,p.category=0,u.RegisterMarker(p)}}else u=L.geoJson(i,{pointToLayer:(t,e)=>L.marker(e,{icon:a})});c.addLayer(u)}return this},this.normaliseZoom=function(e){var i,o,s,n,r;for(r="number"==typeof t.zoom?t.zoom:10,"number"==typeof e&&(r=e),i=-1,o=1/0,s=0;s<t.zoomLevels.length;s++)(n=Math.abs(r-t.zoomLevels[s]))<o&&(i=s,o=n);return i>=0&&(r=t.zoomLevels[i]),r},this.getTiles=function(e,i){var n,r,a;function l(){var r=!0;for(n=0;n<o.length;n++)s[o[n].z][o[n].y][o[n].x].loaded||(r=!1);if(!r)return this;if("function"==typeof t.loaded){var a,l=[];for(n=0;n<o.length;n++)(a=JSON.parse(JSON.stringify(o[n]))).data=s[o[n].z][o[n].y][o[n].x].data,l.push(a);t.loaded.call(t.this||this,l,t,{bounds:e,z:i})}return this}for(i=this.normaliseZoom(i),o=this.xyz(e,i),s[i]||(s[i]={}),n=0;n<o.length;n++)a=o[n].y,r=o[n].x,s[i][a]||(s[i][a]={}),s[i][a][r]||(s[i][a][r]={loaded:!1,url:t.url.replace(/\{x\}/g,r).replace(/\{y\}/g,a).replace(/\{z\}/g,i)},s[i][a][r].fetch=d.call(this,s[i][a][r].url,{x:r,y:a,z:i},l));return l.call(this)},this}(t)},e.WarmSpacesFinder=function(t){return new o(t)},t.OI=e||t.OI||{}}(window||this);